{% extends "main/base.html" %}
{% load static %}
{% block content %}
<div class="container my-5">
  <div class="card shadow p-4">
    <h2 class="text-center mb-4">Snowball Debt Calculator</h2>

    {% if result %}
      <div class="alert alert-info text-center">
        <strong>All loans paid off in {{ result.months }} months.</strong><br>
        <strong>Total Paid:</strong> ${{ result.total_paid }}<br>
        <strong>Total Interest:</strong> ${{ result.total_interest }}
      </div>
    {% endif %}

    <form method="post" id="loan-form">
      {% csrf_token %}
      {{ formset.management_form }}

      {% for form in formset %}
        <div class="card mb-3 p-3 loan-form">
          <h5>Loan {{ forloop.counter }}</h5>
          <div class="mb-2">
            {{ form.name.label_tag }} {{ form.name }}
          </div>
          <div class="mb-2">
            {{ form.balance.label_tag }} {{ form.balance }}
          </div>
          <div class="mb-2">
            {{ form.monthly_payment.label_tag }} {{ form.monthly_payment }}
          </div>
          <div class="mb-2">
            {{ form.interest_rate.label_tag }} {{ form.interest_rate }}
          </div>
          <div class="mb-2">
            {{ form.DELETE }} <label for="{{ form.DELETE.id_for_label }}">Delete this loan</label>
          </div>
        </div>
      {% endfor %}

      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-secondary" onclick="addLoan()">+ Add Another Loan</button>
        <button type="submit" class="btn btn-primary">Calculate</button>
      </div>
    </form>

    {% if result %}
      <div class="mt-5">
        <canvas id="chart" height="120"></canvas>
      </div>
    {% endif %}
  </div>
</div>

{% if result %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('chart').getContext('2d');
    const chartData = JSON.parse('{{ result.data_json|escapejs }}');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartData.map((_, i) => `Month ${i + 1}`),
        datasets: [{
          label: 'Remaining Balance',
          data: chartData,
          borderColor: 'blue',
          backgroundColor: 'rgba(0,123,255,0.1)',
          borderWidth: 2,
          fill: true
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Balance ($)'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Months'
            }
          }
        }
      }
    });
  </script>
{% endif %}

<script>
function addLoan() {
  const totalForms = document.getElementById('id_form-TOTAL_FORMS');
  const formCount = parseInt(totalForms.value);
  const formContainer = document.querySelector('#loan-form');
  const lastForm = document.querySelectorAll('.loan-form')[formCount - 1];
  const newForm = lastForm.cloneNode(true);

  newForm.querySelectorAll('input').forEach(input => {
    const name = input.name.replace(/-(\d+)-/, `-${formCount}-`);
    const id = input.id.replace(/-(\d+)-/, `-${formCount}-`);
    input.name = name;
    input.id = id;
    if (input.type === 'text' || input.type === 'number') input.value = '';
    if (input.type === 'checkbox') input.checked = false;
  });

  formContainer.insertBefore(newForm, formContainer.querySelector('.d-flex'));
  totalForms.value = formCount + 1;
}
</script>
{% endblock %}
