{% extends "main/base.html" %}
{% load static %}
{% block content %}
<div class="container my-5">
  <div class="card shadow p-4">
    <h2 class="text-center mb-4">Budgeting Tool</h2>

    <form method="post">
      {% csrf_token %}
      <div class="mb-3">
        <label for="income" class="form-label">Monthly Income ($)</label>
        <input type="number" name="income" step="0.01" class="form-control" placeholder="Enter income" value="{{ income }}" required>
      </div>
      <button type="submit" class="btn btn-primary w-100">Calculate Budget</button>
    </form>

    {% if allocations %}
      <div class="mt-5">
        <canvas id="budgetChart" height="150"></canvas>
      </div>

      <ul class="list-group mt-4">
        {% for label, value, color in allocations %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <span class="d-flex align-items-center">
            <span style="display: inline-block; width: 15px; height: 15px; margin-right: 10px; background-color: {{ color }};" aria-hidden="true"></span>
            {{ label }}
          </span>
          <strong>${{ value }}</strong>
        </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('budgetChart').getContext('2d');
  const data = JSON.parse('{{ result|default:"[]"|escapejs }}');
  const labels = JSON.parse('{{ labels|escapejs }}');
  const colors = JSON.parse('{{ colors|escapejs }}');

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data.length ? data : Array(labels.length).fill(1),
        backgroundColor: data.length ? colors : ['#d3d3d3'],
        borderWidth: 1
      }]
    },
    options: {
      cutout: '70%',
      plugins: {
        legend: { position: 'right' },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.raw;
              return data.length ? `$${value}` : 'Not yet calculated';
            }
          }
        }
      }
    }
  });
</script>
{% endblock %}
