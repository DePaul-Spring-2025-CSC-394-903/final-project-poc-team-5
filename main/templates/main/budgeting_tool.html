{% extends "main/base.html" %}
{% load static %}
{% block content %}
<div class="container my-5">
  <div class="card shadow p-4">
    <h2 class="text-center mb-4">Budgeting Tool</h2>
    <form method="post" id="budget-form">
      {% csrf_token %}
      <div class="mb-3">
        <label for="income">Monthly Income ($)</label>
        <input type="number" name="income" id="income" step="0.01" class="form-control" placeholder="Enter income" value="{{ income }}">
      </div>
      <button type="submit" class="btn btn-primary w-100">Calculate Budget</button>
    </form>

    <div class="mt-5">
      <canvas id="budgetChart" height="150"></canvas>
    </div>

    {% if allocations %}
      <form id="allocation-form" class="mt-4">
        <ul class="list-group">
          {% for label, value, color in allocations %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span class="d-flex align-items-center">
                <span style="display:inline-block; width:15px; height:15px; margin-right:10px; background-color: {{ color|default:'#cccccc' }};"></span>
                {{ label }}
              </span>
              <input type="number" step="0.01" class="form-control w-25 text-end category-input" name="{{ label }}" value="{{ value }}" data-label="{{ label }}" data-color="{{ color }}">
            </li>
          {% endfor %}
        </ul>
      </form>
    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('budgetChart').getContext('2d');
  const data = JSON.parse('{{ result|default:"[]"|escapejs }}');
  const labels = JSON.parse('{{ labels|escapejs }}');
  const colors = JSON.parse('{{ colors|escapejs }}');

  const chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data.length ? data : Array(labels.length).fill(1),
        backgroundColor: data.length ? colors : ['#d3d3d3'],
        borderWidth: 1
      }]
    },
    options: {
      cutout: '70%',
      plugins: {
        legend: { position: 'right' },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.raw;
              return data.length ? `$${value}` : 'Not yet calculated';
            }
          }
        }
      }
    }
  });

  document.querySelectorAll('.category-input').forEach(input => {
    input.addEventListener('input', () => {
      const values = Array.from(document.querySelectorAll('.category-input')).map(i => parseFloat(i.value) || 0);
      const totalIncome = values.reduce((a, b) => a + b, 0);
      document.getElementById('income').value = totalIncome.toFixed(2);

      chart.data.datasets[0].data = values;
      chart.update();
    });
  });
</script>
{% endblock %}
